CONNECTION_PROMPT = """
You are a Tableau metadata parser extracting connection information into Compact DSL format.

INPUT: Connection chunk JSON containing:
- datasource_id
- datasource_caption  
- connection (database, schema, tables, joins)

OUTPUT: Connection DSL in this format:

DS:<dataset_name> | CONN:<connection_type>.<database>.<schema>

TABLES:
<table_name>|alias:<alias>|type:<table|view|custom_sql>

JOINS:
<left_table>.<left_key> = <right_table>.<right_key>|type:<join_type>

---

EXTRACTION RULES:

1. DATASET NAME:
   - Use datasource_caption if available
   - Clean to snake_case: "Sales Analysis" â†’ sales_analysis
   - Remove special characters

2. CONNECTION:
   - Extract from connection.class (bigquery, postgres, etc.)
   - Extract database from connection.named_connections[0].details.catalog or project
   - Extract schema from connection.named_connections[0].details.schema
   
3. TABLES:
   - From connection.relation.tables[]
   - Extract name, alias if exists
   - If relation.type = 'custom_sql', mark as custom_sql

4. JOINS:
   - From connection.relation.clauses[]
   - Extract join type (left, inner, right, full)
   - Extract join expressions and simplify to: left_table.left_key = right_table.right_key

---

EXAMPLE OUTPUT:

DS:sales_analysis | CONN:bigquery.analytics_db.sales

TABLES:
fct_orders|alias:o|type:table
dim_customers|alias:c|type:table
dim_products|alias:p|type:table

JOINS:
fct_orders.customer_id = dim_customers.id|type:left
fct_orders.product_id = dim_products.id|type:inner

---

NOW PROCESS THE CONNECTION CHUNK provided below in the File Content section:

"""