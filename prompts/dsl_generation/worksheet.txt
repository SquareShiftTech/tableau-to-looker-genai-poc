WORKSHEET_CHUNK_PROMPT = """
You are a Tableau metadata parser extracting worksheet definitions into Compact DSL format.

INPUT: Worksheet batch chunk JSON containing:
- workbook_id
- worksheet_chunk_id
- worksheet_count - number of worksheets in this batch
- datasource_chunk_references[] - array of datasource chunk file names that contain the fields used
- worksheets[] - array of worksheet objects, each containing:
  - worksheet_id
  - worksheet_name
  - datasources[] - array of datasources used
  - datasource_dependencies[] - array of fields used
  - table structure (rows, cols, panes, marks, encodings)
  - filters[]
  - style rules

IMPORTANT: Field references in worksheets may reference fields from the datasource_chunk_references.
You may need to look up field names in those chunks to properly map field references.

OUTPUT: Worksheet DSL in this format (one DSL block per worksheet):

WS:<worksheet_name>|datasource:<datasource_id>

ROWS:
<field_reference>|<aggregation>|<format>

COLS:
<field_reference>|<aggregation>|<format>

MARKS:
<mark_type>|color:<field>|size:<field>|text:<field>|shape:<field>|detail:<field>|tooltip:<fields>

FILTERS:
<field_reference>|type:<filter_type>|values:<values>|mode:<mode>

---

CRITICAL: FIELD REFERENCE MAPPING

For EVERY field reference in the worksheet:
1. Extract the full Tableau field reference (e.g., [federated.xxx].[sum:Sales:qk])
2. Map to cleaned field_name from the datasource fields
3. Extract aggregation if present (sum, avg, count, etc.)
4. Extract date derivation if present (year, month, quarter, etc.)

FIELD REFERENCE PATTERNS:
- [datasource_id].[sum:Field:qk] → field_name|sum
- [datasource_id].[avg:Field:qk] → field_name|avg
- [datasource_id].[yr:Field:ok] → field_name|year
- [datasource_id].[tmn:Field:qk] → field_name|month
- [datasource_id].[none:Calculation_xxx:nk] → calculation_field_name|none
- [datasource_id].[tyr:Field:ok] → field_name|year_trunc

---

EXTRACTION RULES:

1. WORKSHEET NAME:
   - From worksheet.name attribute
   - Clean to snake_case: "Yearly Sales" → yearly_sales
   - Remove special characters

2. DATASOURCE:
   - From datasources[] array
   - Extract datasource name/id
   - Use the primary datasource (first one or most referenced)

3. ROWS:
   - From table.rows element
   - Extract field references
   - Extract aggregation (sum, avg, count, etc.)
   - Extract format if specified
   
   Format: field_name|aggregation|format
   Example: sales|sum|currency

4. COLS:
   - From table.cols element
   - Extract field references (may be compound expressions)
   - Extract date derivations (year, month, quarter, etc.)
   - Extract format if specified
   
   Format: field_name|derivation|format
   Example: order_date|year|date
   
   For compound expressions like (year * month), extract each part:
   order_date|year,order_date|month

5. MARKS:
   - From panes[].mark.class (Bar, Line, Circle, Square, etc.)
   - From panes[].encodings[]:
     - color → color encoding
     - size → size encoding
     - text → text label encoding
     - shape → shape encoding
     - detail → detail encoding
     - tooltip → tooltip fields
   
   Format: mark_type|color:field|size:field|text:field|shape:field|detail:field|tooltip:field1,field2
   Example: Bar|color:category|text:sales|tooltip:profit,quantity

6. FILTERS:
   - From view.filters[] or quick-filters
   - Extract field reference
   - Extract filter type (categorical, quantitative, relative_date, etc.)
   - Extract filter values or range
   - Extract filter mode (include, exclude, etc.)
   
   Format: field_name|type:filter_type|values:value1,value2|mode:include
   Example: order_date|type:relative_date|values:last_30_days|mode:include
   Example: category|type:categorical|values:Electronics,Furniture|mode:include

---

MARK TYPE MAPPING:

From mark.class:
- Bar → bar
- Line → line
- Circle → circle
- Square → square
- Polygon → polygon
- Area → area
- Text → text
- Gantt → gantt
- Map → map

---

AGGREGATION MAPPING:

From field derivation or aggregation:
- sum → sum
- avg → avg
- count → count
- countd → count_distinct
- min → min
- max → max
- median → median
- stdev → stdev
- var → variance

---

DATE DERIVATION MAPPING:

From column-instance.derivation:
- Year → year
- Month → month
- Quarter → quarter
- Week → week
- Day → day
- Year-Trunc → year_trunc
- Month-Trunc → month_trunc
- Quarter-Trunc → quarter_trunc

---

EXAMPLE INPUT WORKSHEET BATCH:
```json
{
  "workbook_id": "Sales_Summary",
  "worksheet_chunk_id": 0,
  "worksheet_count": 2,
  "datasource_chunk_references": [
    "chunk_federated.1dwxh5b1xiulhr1a2s1ww1v7uh53_fields_0",
    "chunk_federated.1dwxh5b1xiulhr1a2s1ww1v7uh53_fields_1"
  ],
  "worksheets": [
    {
      "worksheet_id": "Yearly Sales (2)",
      "worksheet_name": "Yearly Sales (2)",
      "datasources": [
        {
          "name": "federated.1dwxh5b1xiulhr1a2s1ww1v7uh53",
          "caption": "Order_Details (Super_Store_Sales)"
        }
      ],
      "datasource_dependencies": [
        {
          "name": "[sum:Sales:qk]",
          "caption": "Sales",
          "role": "measure",
          "derivation": "Sum"
        }
      ],
      "table": {
        "rows": "[federated.1dwxh5b1xiulhr1a2s1ww1v7uh53].[sum:Sales:qk]",
        "cols": "[federated.1dwxh5b1xiulhr1a2s1ww1v7uh53].[tyr:Order_Date:ok]"
      },
      "panes": [
        {
          "mark": {"class": "Bar"},
          "encodings": [
            {"type": "color", "column": "[federated.1dwxh5b1xiulhr1a2s1ww1v7uh53].[none:Calculation_573927538591830016:nk]"}
          ]
        }
      ],
      "filters": []
    },
    {
      "worksheet_id": "Monthly Sales",
      "worksheet_name": "Monthly Sales",
      "datasources": [
        {
          "name": "federated.1dwxh5b1xiulhr1a2s1ww1v7uh53",
          "caption": "Order_Details (Super_Store_Sales)"
        }
      ],
      "table": {
        "rows": "[federated.1dwxh5b1xiulhr1a2s1ww1v7uh53].[sum:Sales:qk]",
        "cols": "[federated.1dwxh5b1xiulhr1a2s1ww1v7uh53].[tmn:Order_Date:qk]"
      }
    }
  ]
}
```

EXAMPLE OUTPUT (process each worksheet in the batch):
```
=== WORKSHEET 1: yearly_sales_2 ===

WS:yearly_sales_2|datasource:federated.1dwxh5b1xiulhr1a2s1ww1v7uh53

ROWS:
sales|sum

COLS:
order_date|year_trunc

MARKS:
bar|color:calculation_573927538591830016

FILTERS:
(none)

=== WORKSHEET 2: monthly_sales ===

WS:monthly_sales|datasource:federated.1dwxh5b1xiulhr1a2s1ww1v7uh53

ROWS:
sales|sum

COLS:
order_date|month_trunc

MARKS:
(none)

FILTERS:
(none)
```

---

PROCESSING BATCHED WORKSHEETS:

1. Process EACH worksheet in the worksheets[] array
2. For each worksheet, generate a complete DSL block
3. Separate each worksheet's DSL with a clear divider (=== WORKSHEET N: name ===)
4. Use datasource_chunk_references to look up field names if needed
5. Map field references using the same patterns as before

FIELD REFERENCE RESOLUTION:
- If a field reference doesn't match datasource_dependencies directly, check the referenced datasource chunks
- Field names should be cleaned to snake_case consistently
- Use the datasource_chunk_references to understand which chunks contain the field definitions

VALIDATION:

Before output, verify:
✅ Each worksheet in the batch has its own DSL block
✅ Worksheet names are snake_case
✅ All field references map to cleaned field names from datasource chunks
✅ Aggregations are correctly extracted
✅ Mark types are valid
✅ Encodings reference valid fields
✅ Filters have proper type and values
✅ Date derivations are correctly mapped
✅ Output is clearly separated by worksheet

---

NOW PROCESS THIS WORKSHEET BATCH CHUNK provided below in the File Content section:

"""

